---
title: "individual project-qn-2"
author: "Ammar"
date: "2023-09-08"
output: 
  bookdown::html_document2:
      toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-packages, message=FALSE, warning=FALSE}
library(igraph)
library(here)
library(data.table)
library(ggplot2)
library(hrbrthemes)
library(gridExtra)
```

```{r simplify-graph}
file_path_2018 <- here("indiv-project/trade-network/2018.net")
g2018 <- read_graph(file_path_2018,format="pajek")

#sum weights in g2018 to remove multi-edges
g2018 <- simplify(g2018, edge.attr.comb = "sum") #sums weights of repeated edges
```

```{r compute-diameter-function}
# Function to compute diameter after node removal
graph_deletion <- function(graph, removal_fraction, approach) {
  
  #this function takes in a graph object, the percentage of nodes to be removed, and the approach to deletion, namely "random" or "targeted"
  #targeted approach is using centrality 
  
  num_nodes_to_remove <- floor(vcount(graph) * removal_fraction) #round down number of ndoes to be removed
  
  # Create a copy of the original graph
  g_copy <- copy(graph)
  
  # Sort nodes by centrality measure if using targeted deletion
  if (approach == "targeted") {
    close_centr <- igraph::closeness(graph)
    nodes_to_remove <- order(close_centr, decreasing = TRUE)[1:num_nodes_to_remove]
  } else {
    # Randomly select nodes for removal
    nodes_to_remove <- sample(1:vcount(graph), num_nodes_to_remove)
  }
  
  # Remove selected nodes
  g_copy <- delete_vertices(g_copy, nodes_to_remove)
  
  return(g_copy)
}

```

```{r removal-fractions}
set.seed(32)
# Define a range of fractions for node removal
removal_fractions <- seq(0, 0.9, by = 0.1)
```

```{r}
# Function for graph deletion and plotting using ggplot2
graph_deletion_diameter_plot_ggplot <- function(graph, removal_fractions, year, title = TRUE, label = TRUE) {
  
  # Initialize data frame to store results
  result_data <- data.frame(Fraction = numeric(0), Diameter = numeric(0), Approach = character(0))
  
  # Perform node removal for each fraction and approach
  for (fraction in removal_fractions) {
    for (approach in c("random", "targeted")) {
      g_copy <- graph_deletion(graph, fraction, approach)
      diameter_value <- diameter(g_copy)
      result_data <- rbind(result_data, data.frame(Fraction = fraction, 
                                                   Diameter = diameter_value, 
                                                   Approach = approach))
    }
  }

  # Create a ggplot2 plot
  plot <- ggplot(result_data, aes(x = Fraction, y = Diameter, color = Approach)) +
    geom_line() +
    xlab("Fraction of Nodes Removed") +
    ylab("Diameter") +
    scale_color_manual(values = c("blue", "red")) +
    theme_minimal()
  
  # Add a title if title = TRUE
  if (title) {
    plot <- plot + ggtitle(paste("Change in Diameter vs. Node Removal", year))
  } else {
    plot <- plot + ggtitle(year)
  }
  
  # Show the legend if label = TRUE
  if (label) {
    plot <- plot + labs(color = "Approach") +
      theme(legend.position = "top",
            legend.justification='left',
            legend.direction='horizontal')
  }
  
  return(plot)
}
```


# Qn 2a

```{r graph-plot}
graph_deletion_diameter_plot_ggplot(g2018, removal_fractions, "2018")
```

# Qn 2b

In addition to diameter, another attribute that can potentially measure the resilience of the trade network to node removals is the "Size of the Giant Component" or "Size of the Largest Connected Component."

The Size of the Giant Component represents the number of nodes within the largest connected component of the network after node removal. A higher Size of the Giant Component indicates a more resilient network because it signifies that a larger portion of the network remains connected despite node removals.

```{r compute-giant-component-function}
# Function to compute Size of the Giant Component after node removal
compute_giant_component_after_removal <- function(graph, removal_fraction, approach) {
  num_nodes_to_remove <- floor(vcount(graph) * removal_fraction)
  
  # Create a copy of the original graph
  g_copy <- copy(graph)
  
  # Sort nodes by centrality measure if using targeted deletion
  if (approach == "targeted") {
    centrality <- igraph::closeness(graph)
    nodes_to_remove <- order(centrality, decreasing = TRUE)[1:num_nodes_to_remove]
  } else {
    # Randomly select nodes for removal
    nodes_to_remove <- sample(1:vcount(graph), num_nodes_to_remove)
  }
  
  # Remove selected nodes
  g_copy <- delete_vertices(g_copy, nodes_to_remove)
  
  # Compute and return the size of the giant component of the modified graph
  largest_component <- clusters(g_copy)$csize
  max(largest_component)
}
```

```{r t-test-function}
giant_component_ttest <- function(graph, removal_fractions, significance_val=0.05){
  # Initialize vectors to store the Size of the Giant Component
  giant_component_random <- numeric(length(removal_fractions))
  giant_component_targeted <- numeric(length(removal_fractions))

  # Perform computation for Size of the Giant Component after node removal
  for (i in 1:length(removal_fractions)) {
    fraction <- removal_fractions[i]
    
    # Random node deletion approach
    giant_component_random[i] <- compute_giant_component_after_removal(graph, fraction, "random")
    
    # Targeted node deletion approach
    giant_component_targeted[i] <- compute_giant_component_after_removal(graph, fraction, "targeted")
  }
  
  # Perform t-test to compare the means of the Size of the Giant Component for random and targeted deletions
  t_test_result <- t.test(giant_component_random, giant_component_targeted, alternative = "two.sided")
  }
```


```{r 2018-giant-component-ttest}

result <- giant_component_ttest(g2018, removal_fractions, significance_val=0.05)

# Print the results of the t-test
cat("T-test results:\n")
print(result)
```

## Findings

In summary, the t-test results show that there is **no strong evidence** to conclude that the means of the Size of the Giant Component for random and targeted node deletions are significantly different. The relatively high p-value (0.8361) suggests that the observed difference in means could be due to random variation, and it is **not statistically significant**.


```{r import-graphs}
file_path_2000 <- here("indiv-project/trade-network/2000.net")
g2000 <- read_graph(file_path_2000,format="pajek")

file_path_2005 <- here("indiv-project/trade-network/2005.net")
g2005 <- read_graph(file_path_2005,format="pajek")

file_path_2010 <- here("indiv-project/trade-network/2010.net")
g2010 <- read_graph(file_path_2010,format="pajek")

file_path_2015 <- here("indiv-project/trade-network/2015.net")
g2015 <- read_graph(file_path_2015,format="pajek")
```

# Qn 2c


```{r deletion-plot-over-the-years}
# Create a list of graph objects
graph_list <- list(g2000, g2005, g2010, g2015, g2018)

# Create a list of years
years <- c("2000", "2005", "2010", "2015", "2018")

# Initialize an empty data frame to store the results
result_data <- data.frame()

# Loop through each graph and year
for (i in 1:length(graph_list)) {
  graph <- graph_list[[i]]
  year <- years[i]
  
  # Perform node removal for each fraction and approach
  for (fraction in removal_fractions) {
    for (approach in c("random", "targeted")) {
      g_copy <- graph_deletion(graph, fraction, approach)
      diameter_value <- diameter(g_copy)
      result_data <- rbind(result_data, data.frame(Fraction = fraction, Diameter = diameter_value, Approach = approach, Year = year))
    }
  }
}

# Create a ggplot2 plot using facet_grid
plot <- ggplot(result_data, aes(x = Fraction, y = Diameter, color = Approach)) +
  geom_line() +
  xlab("Fraction of Nodes Removed") +
  ylab("Change in Diameter") +
  scale_color_manual(values = c("blue", "red")) +
  theme_minimal() +
  facet_wrap(Year ~ ., ncol=5) 

# Show the plot
print(plot)

```

We can see that across the years, there was a **highly significant** change in diameter of the graph is highest in 2015 followed by 2018. However, when we compare them against the years 2000 - 2010, there was **minimal difference** in the change in diameter as the nodes were deleted. In 2000 and 2010, there was a slight spike in the change of diameter after the fraction of nodes deleted increased past ~ 0.7.

This tells us that **between 2000-2010**, the network was **much more resilient** as compared to **after the year 2015**.

```{r p-value-function}
get_p_value <- function(ttest){
  return(ttest$p.value)
}
```

```{r t-test-over-the-years}

ttest_years <- data.frame(
  year = c("2000", "2005", "2010", "2015", "2018"),
  p_value = c(
    get_p_value(giant_component_ttest(g2000, removal_fractions, significance_val=0.05)),
    get_p_value(giant_component_ttest(g2005, removal_fractions, significance_val=0.05)),
    get_p_value(giant_component_ttest(g2010, removal_fractions, significance_val=0.05)),
    get_p_value(giant_component_ttest(g2015, removal_fractions, significance_val=0.05)),
    get_p_value(giant_component_ttest(g2018, removal_fractions, significance_val=0.05))
  )
)

ttest_years

```
## Findings

In summary, the t-test results show that there is **no strong evidence** to conclude that the means of the Size of the Giant Component for random and targeted node deletions are significantly different across all the years. However, it is weird to note that the p-value of these t-tests remain the same from the year 2000 to 2015, only changing in 2015.

```{r t-test-check, include=FALSE}
# seconday check of t-test
giant_component_random2000 <- numeric(length(removal_fractions))
giant_component_targeted2000 <- numeric(length(removal_fractions))

giant_component_random2005 <- numeric(length(removal_fractions))
giant_component_targeted2005 <- numeric(length(removal_fractions))

giant_component_random2010 <- numeric(length(removal_fractions))
giant_component_targeted2010 <- numeric(length(removal_fractions))

giant_component_random2015 <- numeric(length(removal_fractions))
giant_component_targeted2015 <- numeric(length(removal_fractions))

giant_component_random2018 <- numeric(length(removal_fractions))
giant_component_targeted2018 <- numeric(length(removal_fractions))
  
for (i in 1:length(removal_fractions)) {
    fraction <- removal_fractions[i]
    
    # Random node deletion approach
    giant_component_random2000[i] <- compute_giant_component_after_removal(g2000, fraction, "random")
    giant_component_random2005[i] <- compute_giant_component_after_removal(g2005, fraction, "random")
    giant_component_random2010[i] <- compute_giant_component_after_removal(g2010, fraction, "random")
    giant_component_random2015[i] <- compute_giant_component_after_removal(g2015, fraction, "random")
    giant_component_random2018[i] <- compute_giant_component_after_removal(g2018, fraction, "random")

    
    # Targeted node deletion approach
    giant_component_targeted2000[i] <- compute_giant_component_after_removal(g2000, fraction, "targeted")
    giant_component_targeted2005[i] <- compute_giant_component_after_removal(g2005, fraction, "targeted")
    giant_component_targeted2010[i] <- compute_giant_component_after_removal(g2010, fraction, "targeted")
    giant_component_targeted2015[i] <- compute_giant_component_after_removal(g2015, fraction, "targeted")
    giant_component_targeted2018[i] <- compute_giant_component_after_removal(g2018, fraction, "targeted")


    }

giant_component_random2000
giant_component_targeted2000


giant_component_random2005
giant_component_targeted2005

giant_component_random2010
giant_component_targeted2010

giant_component_random2015
giant_component_targeted2015

giant_component_random2018
giant_component_targeted2018
```


  

---
title: "individual project-qn-1"
author: "Ammar"
date: "2023-09-03"
output: 
  bookdown::html_document2:
      toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-packages, message=FALSE, warning=FALSE}
library(igraph)
library(here)
library(data.table)
library(ggplot2)
library(hrbrthemes)
```

# Qn 1a

## Graph Structure
```{r graph-structure }
# Step 1: Read the edge list from the .txt file
file_path_2000 <- here("indiv-project/trade-network/2000.net")
g2000 <- read_graph(file_path_2000,format="pajek")

str(g2000)
```

## Graph Level Attributes

**Number of Nodes:** `r vcount(g2000)`

**Number of Edges:** `r ecount(g2000)`

**Graph Density:** `r graph.density(g2000)`

**Graph Diameter:** `r diameter(g2000)`

**Size of largest Component:** `r max(components(g2000)$csize)`

**Global Transitivity:** `r transitivity(g2000,type="global")`

**Average Transitivity** `r transitivity(g2000,type="average") `

**Size of Largest Clique:** `r clique_num(g2000)`

There are 161 countries represented in the trade network and a total of 16,335 trade relationships (edges) in the network, indicating a **relatively dense** network.The graph density is approximately 0.634, which suggests that about 63.4% of all possible trade relationships between countries are present. This indicates a **relatively connected** network. The diameter of the graph is 558.699. This represents the longest shortest path between any two countries in the trade network, which is a measure of the network's overall size.

The entire network forms a single connected component with all 161 countries, indicating that there are **no isolated subnetworks**.The global transitivity (clustering coefficient) is approximately 0.842, suggesting that there is a **significant tendency** for groups of countries to engage in trade with one another, forming clusters or communities within the network. The average transitivity is approximately 0.871, which is similar to the global transitivity. This further confirms a **high degree of clustering** within the network. The largest clique in the network consists of 81 countries. This indicates the **presence of a highly interconnected group of countries** that trade extensively with each other.

[Back to top](#) 

## Vertex Attributes

```{r vertex-attributes}
# store attributes into a data.frame
df=data.frame(vertex_id=V(g2000),
              vertex_name=V(g2000)$name,
              degree=degree(g2000),
              closeness=closeness(g2000),
              betweenness=betweenness(g2000,normalized=T),
              transitivity=transitivity(g2000,type="local"),
              eigen_centrality=eigen_centrality(g2000)$vector
              )
knitr::kable(
  summary(df[-c(1,2)]),
  caption = "Vertex Attributes"
)
```

### Betweenness and Transitivity

**Betweenness Centrality:** 

- Betweenness centrality measures how often a country acts as a bridge or intermediary in trade relationships between other countries. The values range from 0 to a maximum of 0.236006, indicating variations in the importance of countries in facilitating trade routes.

- The values are still pretty much quite low, indicating that most countries do not rely on thir party channels to do trade with a country of interest.

**Transitivity:**

- The values range from 0.7591 to 0.9933, suggesting that many countries form tightly interconnected groups in trade networks.

[Back to top](#) 

```{r hist-plot-function}
#create histogram function
hist_plot <- function(table, title, xlab, ylab){
  ggplot(table, aes(x = factor(V1, levels = unique(V1)), y = N)) +
  geom_bar(stat = "identity", fill = "grey") +
  geom_text(aes(label = N), vjust = -0.3) +  # Add labels above the bars
  labs(
    title = title,
    x = xlab,
    y = ylab
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
```

### Closeness Distribution

```{r filtered-close-plot, fig.cap="Filtered Closeness Distribution"}
#closeness for each node - there are NaN values
closeness_values <- closeness(g2000)


# Find vertices with NaN closeness centrality
nan_vertices <- which(is.nan(closeness_values))

# Remove vertices with NaN closeness centrality from the graph
g2000_filtered <- delete.vertices(g2000, nan_vertices)

#explore out closeness
closeness_vector <- closeness(g2000_filtered, mode="out")
max_closeness <- max(closeness_vector)
min_closeness <- min(closeness_vector)

close_table <- data.table(
  table(
    cut(closeness_vector, breaks = seq(min_closeness, max_closeness, 
                                       by=(max_closeness - min_closeness)/10), 
        right = TRUE))
  )

# Create a histogram
hist_plot(
  table=close_table,
  title="Out Closeness Distribution",
  xlab="Closeness", 
  ylab="Number of Countries"
  )
```

**Mean Closeness Centrality in "out" Mode:** These values measure how quickly information or influence can flow from a specific vertex (country) to all other vertices in the network. It assesses how efficiently each country can disseminate information or resources to others

Overall, the out-closeness centrality values are generally very low, with a maximum of no more than 0.00116. Nonetheless, here are some findings:

Based on Figure \@ref(fig:filtered-close-plot) over 120 out of 161 countries have out-closeness centrality $\ge$ 0.000702, which is relatively high.

- The presence of `r length(nan_vertices)` countries with missing closeness centrality values suggests that these countries might only accept imports and not do exports.

[Back to top](#) 

### Eigen Centrality

```{r eigen-plot, fig.cap="Eigen Centrality"}
hist(
  eigen_centrality(g2000)$vector,
  main="Eigen Centrality Distribution",
  xlab="Eigen Centrality",
  ylab="Number of Countries"
  )
```

```{r filtered-eigen-plot, fig.cap="subset of Eigen Centrality" }
eigen_cent_table <- data.table(
  table(cut(eigen_centrality(g2000)$vector, breaks = seq(0, 0.01, by=0.001), 
        right = TRUE))
  )

# Create a histogram
hist_plot(
  table=eigen_cent_table,
  title="Eigen Centrality Distribution",
  xlab="Eigen Centrality", 
  ylab="Number of Countries"
  )
```

Based on Figure \@ref(fig:filtered-eigen-plot) 59 countries have eigen centrality values of between 0 to 0.001, and this forms the majority of the countries.  

- Countries with eigen centrality values in this range are likely to be less influential in the global trade network. They may have limited trade connections or trade relationships that are not strongly influential on a global scale.

- These countries may not play a significant role in shaping global trade patterns. They might have relatively small trade volumes or trade primarily with a limited set of partners.

- Their influence on the network's structure and dynamics is relatively low, and they are less likely to act as intermediaries in trade routes.

The second largest group of countries, approximately 17, have eigen centrality values of between 0.001 to 0.002.

- Countries falling within this range have a somewhat more significant influence on the trade network compared to those in the lower eigen centrality range. They may have more extensive trade connections and contribute to regional trade patterns.

- These countries may play key roles in regional trade blocs or economic partnerships, influencing trade dynamics within their respective regions.

- While not among the most influential in the global trade network, they have a moderate degree of influence on the network's structure and connectivity.

There are very few countries with relatively high eigen centralities, meaning in the year 2000, there was a lack of trade power-hubs.

[Back to top](#) 

### Degree Distribution

```{r create-degree-dataframes}
# Country Exports Table
deg_df <- data.table(as_long_data_frame(g2000)[c("from_name", "to_name")])
out_deg_df <- deg_df[,.(cnt=.N),by=.(from_name)]
in_deg_df <- deg_df[,.(cnt=.N),by=.(to_name)]
```

#### Exports Distribution

```{r out-degree-plot, fig.cap="Out Degree Distribution"}
out_deg_table <- data.table(
  table(cut(out_deg_df$cnt, breaks = seq(0, 161, by=10), right = TRUE))
  )[(N)!=0] #remove bins that does not represent any country

# Create a histogram
hist_plot(
  table=out_deg_table,
  title="Distribution of Exports",
  xlab="Export Range", 
  ylab="Frequency"
  )
```

- The export distribution histogram is generally left-skewed. This means that there are more countries with higher export counts (toward the right side of the distribution) than with lower export counts (toward the left side of the distribution).

- If we look at the distribution from left to right, we can observe that the frequency counts generally decrease as we move from high export count ranges to low export count ranges. 

#### Imports Distribution

```{r in-degree-plot, fig.cap="In Degree Distribution"}
in_deg_table <- data.table(
  table(cut(in_deg_df$cnt, breaks = seq(0, 161, by=10), right = TRUE)) #intervals are left-closed, meaning that the left endpoint is included in the interval, but the right endpoint is not
  )[(N)!=0] #remove bins that does not represent any country

# Create a histogram
hist_plot(
  table=in_deg_table,
  title="Distribution of Imports",
  xlab="Import Range", 
  ylab="Frequency"
  )
```

- Similar to the export distribution, the import distribution is also left-skewed; This means that there are more countries with higher import counts than with lower import counts

- 38 countries import from > 130 countries

- Most countries fall into the middle and lower import count ranges, indicating that the majority of countries have moderate to lower levels of imports. These countries may have smaller markets or lower consumer demand for imports.

Brief description of the degree distribution:

Based on Figure \@ref(fig:in-degree-plot) and Figure \@ref(fig:out-degree-plot)
We can understand that most countries are generally well connected. However, we should explore the distribution of export power and import power of each country We can define export and import power as follows:

$export\,power = \displaystyle \frac{exports}{exports + imports}$

$import\,power = \displaystyle \frac{imports}{exports + imports}$

Let us first look at it the export/ import power from a **degree** perspective

```{r export-import-table}
# Perform the outer join
df2 <- merge(out_deg_df, in_deg_df, by.x = "from_name", by.y = "to_name", all = TRUE)

# Replace missing values (NA) with 0 in the resulting dataframe
df2[is.na(df2)] <- 0

# Rename columns
setnames(df2, c("country", "export_cnt", "import_cnt"))

# Add 'export_degree_power' and 'import_degree_power' columns
df2[, export_degree_power := round(export_cnt / (export_cnt + import_cnt), 3) * 100]
df2[, import_degree_power := round(import_cnt / (export_cnt + import_cnt), 3) * 100]

# Summary
knitr::kable(
  summary(df2),
  caption = "Export and Import Power Summary"
)
```

#### Export Power Degree Distribution

```{r export-degree-power-distribution, fig.cap="Out Degree Power Distribution"}
out_deg_power_table <- data.table(
  table(cut(df2$export_degree_power, breaks = seq(0, 65, by=5), right = TRUE))
  )[(N)!=0]

hist_plot(
  table=out_deg_power_table,
  title="Distribution of Exports Degree Power",
  xlab="Exports Degree Power Range (%)", 
  ylab="Frequency"
  )
```

#### Import Power Degree Distribution

```{r import-degree-power-distribution, fig.cap="In Degree Power Distribution"}
in_deg_power_table <- data.table(
  table(cut(df2$import_degree_power, breaks = seq(35, 100, by=5), right = TRUE))
  )[(N)!=0]

hist_plot(
  table=in_deg_power_table,
  title="Distribution of Imports Degree Power",
  xlab="Imports Degree Power Range (%)", 
  ylab="Frequency"
  )
```

From Fig \@ref(fig:export-degree-power-distribution) and Fig \@ref(fig:import-degree-power-distribution), we can observe that most countries generally engage in more exports than import

- 106 countries have export power of $\ge$ 50%

- 106 countries have import power of $\le$ 50%

This shows that in general, countries generally have more export ties than import ties in the year 2000.

Now, let us take a look at the export/ import power from a **trade volume** perspective

[Back to top](#) 

## Edge Attributes

### Trade Volume vs Ties

```{r create-volume-tables}
trade_df <- data.table(as_long_data_frame(g2000))[, c("weight", "from_name", "to_name")]

# Create export table
export_table <- trade_df[, .(total_export_volume = sum(weight), export_ties = .N), by = from_name]

# Create import table
import_table <- trade_df[, .(total_import_volume = sum(weight), import_ties = .N), by = to_name]

# Perform the outer join
vol_df <- merge(export_table, import_table, by.x = "from_name", by.y = "to_name", all = TRUE)

# Add 'export_vol_power' and 'import_vol_power' columns
vol_df[, export_vol_power := round(total_export_volume / (total_export_volume + total_import_volume), 3) * 100]
vol_df[, import_vol_power := round(total_import_volume / (total_export_volume + total_import_volume), 3) * 100]

#average export and import value per country
vol_df[, ave_export_vol := total_export_volume / export_ties ]
vol_df[, ave_import_vol := total_import_volume / import_ties ]

# Replace missing values (NA) with 0 in the resulting dataframe
vol_df[is.na(vol_df)] <- 0

# Rename country column
setnames(vol_df, old = "from_name", new = "country")

# Summary
knitr::kable(
  summary(vol_df),
  caption = "Export and Import Volume Summary"
)
```

#### Export Power Degree Distribution

```{r fig.cap="Export Ties vs Volume"}
#we use a scatter plot to observe the relationship between the export volume and the number of export ties
ggplot(vol_df, aes(x=export_ties, y=total_export_volume)) +
  geom_point() +
  labs(
    title = "Export Ties vs Export Volume",
    x = "Number of Export Ties",
    y = "Total Export Volume per Country"
  )
```

Since the maximum export volume is significantly larger than the minimum export volume, let us try applying log transformation to the export volume, to minimise the absolute difference in export volumes, and try to observe any trends.

```{r fig.cap="Log transformed export volume against Export Ties",message=FALSE, warning=FALSE}

ex_vol_df <- vol_df[export_ties!=0]

#create scatter plot with line of best fit
ggplot(ex_vol_df, aes(x=export_ties, y=log(total_export_volume))) +
  geom_point() +
  geom_smooth(method=lm, se=FALSE) +
  labs(
    title = "Export Ties vs Export Volume",
    x = "Number of Export Ties",
    y = "Log(Total Export Volume per Country)"
  )
```

```{r lm-exports}
# Fit a linear regression model
model <- lm(log2(total_export_volume) ~ export_ties, data = ex_vol_df)

# Extract the slope coefficient
ex_slope_coefficient <- coef(model)[2]  # Extracts the coefficient for 'export_ties'
```

**Slope Coefficient of Best Fit line:** `r ex_slope_coefficient`

These are some deductions that can be made:

**Positive Linear Relationship: **
The log-transformed total export volume and the number of export ties show a positive linear relationship. As the number of export ties increases, the log-transformed export volume tends to increase as well. This suggests that there is a tendency for countries with more export ties to have higher export volumes.

**Magnitude of Change:** Since the dependent variable (total_export_volume) is log-transformed, we can interpret the coefficient as a percentage change in the original export volume. Specifically, a one-unit increase in export ties is associated with an estimated increase of approximately 8.04% in the original export volume (not on the log scale).

**Exponential Growth in Export Volume: **
The log transformation is often used to stabilize variance when dealing with data that spans several orders of magnitude. In this case, it helps reveal that the growth in export volume is not linear but rather exponential. As countries establish more export ties, their export volumes tend to grow exponentially.

```{r fig.cap="Import Ties vs Volume"}
#we use a scatter plot to observe the relationship between the export volume and the number of export ties
ggplot(vol_df, aes(x=import_ties, y=total_import_volume)) +
  geom_point() +
  labs(
    title = "Import Ties vs Import Volume",
    x = "Number of Import Ties",
    y = "Total Import Volume per Country"
  )
```

Similarly, the maximum import volume is significantly larger than the minimum import volume, let us try applying log transformation to the import volume, to minimise the absolute difference in import volumes, and try to observe any trends.

```{r fig.cap="Log transformed import volume against Import Ties",message=FALSE, warning=FALSE}

im_vol_df <- vol_df[import_ties!=0]

#create scatter plot with line of best fit
ggplot(im_vol_df, aes(x=import_ties, y=log(total_import_volume))) +
  geom_point() +
  geom_smooth(method=lm, se=FALSE) +
  labs(
    title = "Import Ties vs Import Volume",
    x = "Number of Import Ties",
    y = "Log(Total Import Volume per Country)"
  )
```

```{r lm-imports}
# Fit a linear regression model
model <- lm(log2(total_import_volume) ~ import_ties, data = im_vol_df)

# Extract the slope coefficient
im_slope_coefficient <- coef(model)[2]  # Extracts the coefficient for 'export_ties'
```

**Slope Coefficient of Best Fit line:** `r im_slope_coefficient`

**Positive Linear Relationship: **
The log-transformed total import volume and the number of import ties show a positive linear relationship. As the number of import ties increases, the log-transformed import volume tends to increase as well. This suggests that there is a tendency for countries with more import ties to have higher import volumes.

**Magnitude of Change:** Since the dependent variable (total_import_volume) is log-transformed, we can interpret the coefficient as a percentage change in the original import volume. Specifically, a one-unit increase in import ties is associated with an estimated increase of approximately 10.66% in the original import volume (not on the log scale). 

**Note: This is greater than the estimated increase in original export volume with a one-unit increase in export ties.**

**Exponential Growth in Export Volume: **
As countries establish more import ties, their import volumes tend to grow exponentially.

[Back to top](#) 

### Trade Volume Power

Recap:

$export\,power = \displaystyle \frac{exports}{exports + imports}$

$import\,power = \displaystyle \frac{imports}{exports + imports}$

```{r export-vol-power, fig.cap = "Distribution of Imports/ Exports Volume Power"}
library(ggpubr)

out_vol_power_table <- data.table(
  table(cut(vol_df$export_vol_power, breaks = seq(0, 100, by=10), right = TRUE))
  )

in_vol_power_table <- data.table(
  table(cut(vol_df$import_vol_power, breaks = seq(0, 100, by=10), right = TRUE))
  )

a <- hist_plot(
  table=in_vol_power_table,
  title="Distribution of Imports Volume Power",
  xlab="Imports Volume Power Range (%)", 
  ylab="Frequency"
  )

b <- hist_plot(
  table=out_vol_power_table,
  title="Distribution of Exports Volume Power",
  xlab="Exports Volume Power Range (%)", 
  ylab="Frequency"
  )

ggarrange(a, b, ncol=1, nrow=2)

```


In General, more countries have a higher percentage of exports than imports. Well, this is to be expected since countries generally have more export ties than import ties in the year 2000 as we have discovered earlier.


[Back to top](#) 


# Qn 1b
```{r graph-structures-all-years }
# Step 1: Read the edge list from the .txt file
file_path_2005 <- here("indiv-project/trade-network/2005.net")
g2005 <- read_graph(file_path_2005,format="pajek")

file_path_2010 <- here("indiv-project/trade-network/2010.net")
g2010 <- read_graph(file_path_2010,format="pajek")

file_path_2015 <- here("indiv-project/trade-network/2015.net")
g2015 <- read_graph(file_path_2015,format="pajek")

file_path_2018 <- here("indiv-project/trade-network/2018.net")
g2018 <- read_graph(file_path_2018,format="pajek")

#sum weights in g2018 to remove multi-edges
g2018 <- simplify(g2018, edge.attr.comb = "sum") #sums weights of repeated edges
```


```{r define-functions }

graph_att <- function(graph, year){
  #this function returns a graph attributes in a data.table object
  df <- data.table::data.table(
    number_of_nodes=igraph::vcount(graph),
    number_of_edges=igraph::ecount(graph),
    density=igraph::graph.density(graph),
    diameter=igraph::diameter(graph),
    largest_component_size=max(igraph::components(graph)$csize),
    global_clustering_coeff=igraph::transitivity(graph,type="global"),
    ave_clustering_coeff=igraph::transitivity(graph,type="average"),
    number_of_cliques=igraph::clique_num(graph),
    year=year
  )
  return(df)
}


vertex_att <- function(graph, year){
  #this function returns some vertex attributes of a graph in a data.table object
   df <- data.table::data.table(
     vertex_id=igraph::V(graph),
     vertex_name=igraph::V(graph)$name,
     degree=igraph::degree(graph),
     closeness=igraph::closeness(graph),
     betweenness=igraph::betweenness(graph,normalized=T),
     transitivity=igraph::transitivity(graph,type="local"),
     eigen_centrality=igraph::eigen_centrality(graph)$vector,
     year=year
     )
   return(df)
}

get_top_5 <- function(df, col_of_interest){
  x <- order(data, na.last = TRUE, decreasing = FALSE)
  return(x[1:5, c("vertex_name", col_of_interest)])
}
```

## Graph Level Attributes

### Overall Summary

```{r graph-att-summary-years, message=FALSE, warning=FALSE}
g_list <- list(g2000, g2005, g2010, g2015, g2018)
years <- c("2000", "2005", "2010", "2015", "2018")

graph_att_df <- data.table()
#inititate for loop that will append graph attributes of all years
for (i in seq(1, 5)){
  graph <- g_list[[i]] #extract graph
  year <- years[i] #extract year
  graph_att_df <- rbindlist(list(graph_att_df, #existing graph attributes dataframe
                                 graph_att(g_list[[i]], years[i]) #bind new graph attributes
                                 )
                            )
}
knitr::kable(
  graph_att_df,
  caption = "Vertex Attributes 2000-2018"
)
```

From the above summary, it seems that the attributes that have undergone **relatively significant** changes:

1. Density
2. Diameter 
3. Number of cliques. 
4. Number of Edges

the attributes that have undergone **no change/ relatively insignificant** changes:

1. Number of Nodes
2. Largest Component Size
3. Global clustering coefficient
4. Average clustering Coefficient

```{r density-vs-time, fig.cap="Density Over Time"}
ggplot(graph_att_df, aes(x=year, y=density)) +
    geom_line( color="grey", group=1) +
    geom_point(shape=21, color="black", fill="#69b3a2", size=6) +
    theme_ipsum() +
    ggtitle("Evolution of Density")
```

**Note:** Since the number of countries in this trade network remains the same, it suffices to plot only number one out of edges vs density against time.

```{r cliques-vs-time, fig.cap="Number of cliques Over Time"}
ggplot(graph_att_df, aes(x=year, y=number_of_cliques)) +
    geom_line( color="grey", group=1) +
    geom_point(shape=21, color="black", fill="#b3a369", size=6) +
    theme_ipsum() +
    ggtitle("Evolution of Number of Cliques")
```


**Steady Start (2000-2005):** The journey begins with a relatively stable number of 81 cliques in 2000, showing a modest increase to 87 by 2005. During this period, the trade networks exhibited a degree of stability in terms of cliques. Countries maintained relatively consistent trade partnerships.

**Gradual Growth (2005-2010):** The trend continues with a gradual increase in the number of cliques, reaching 96 by 2010. This period may reflect a growing complexity in trade relationships, potentially influenced by several factors:

**Global Economic Shifts:** The global economy was evolving, with emerging markets gaining prominence. These shifts could have led to the formation of new trade cliques as countries explored diverse partnerships.

**Sustained Complexity (2010-2015):** The number of cliques remains at 96 between 2010 and 2015, indicating a level of stability in trade relationships. During this time, countries likely continued to deepen their trade ties while maintaining existing ones.

**Marginal Increase (2015-2018):** The trend edges slightly upward, reaching 97 cliques in 2018. This small increase may be indicative of ongoing trade evolution, with countries exploring additional trade partnerships.


```{r diameter-vs-time, fig.cap="Diameter Over Time"}
ggplot(graph_att_df, aes(x=year, y=diameter)) +
    geom_line( color="grey", group=1) +
    geom_point(shape=21, color="black", fill="#bf546f", size=6) +
    theme_ipsum() +
    ggtitle("Evolution of Diameter")
```

**Steady Start (2000-2005):** The journey begins with a relatively stable diameter of 558.699 in 2000, dipping slightly to 533.426 by 2005. During this period, the trade network seemed well-connected, with most countries maintaining trade relationships.

**Dramatic Surge (2005-2010):** The real excitement unfolds between 2005 and 2010 when the diameter skyrockets to 4398.377. This surge suggests a significant expansion in trade connections. Several factors contribute:

- **Globalization Momentum:** The global economy was in full swing, with emerging markets like China and India playing pivotal roles. Their economic growth led to diverse trade links.

**Continued Growth (2010-2015):** The trend marches on, with the diameter reaching 8900.980 in 2015. This period signifies a deepening of trade relationships, further globalization, and economic interdependence.

**Exponential Expansion (2015-2018):** The most remarkable chapter unfolds from 2015 to 2018 when the diameter skyrockets to 29925.927. This exponential growth indicates an incredibly intricate and interconnected trade network. Here are some possible reasons for this trend:

- **Emerging Economies:** Emerging economies, especially in Asia and Africa, experienced rapid growth. Their economic prowess drove heightened trade activity and links with other nations.

- **Digital Commerce:** The rise of e-commerce and digital trade expanded the range of goods and services exchanged, creating additional trade connections.


## Vertex Level Attributes

```{r vertex-att-summary-years, message=FALSE, warning=FALSE}
# v_2000 <- vertex_att(g2000, "2000")
# v_2005 <- vertex_att(g2005, "2005")
# v_2010 <- vertex_att(g2010, "2010")
# v_2015 <- vertex_att(g2000, "2015")
# v_2018 <- vertex_att(g2000, "2018")
# getwd()
# summary(v_2018)
```



